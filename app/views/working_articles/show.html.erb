<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-md-11">
      <div class="w-100" style="margin-bottom: 5em;">
        <ul class="nav nav-tabs justify-content-center mb-3" id="myTab" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" id="edit-tab" data-toggle="tab" href="#edit" role="tab" aria-controls="edit" aria-selected="true">
              <%= @working_article.page.page_number %>번 기사편집
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="picture-tab" data-toggle="tab" href="#picture" role="tab" aria-controls="picture" aria-selected="false">
              사진 편집
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="graphic-tab" data-toggle="tab" href="#graphic" role="tab" aria-controls="graphic" aria-selected="false">
              그래픽 편집
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="group-image-tab" data-toggle="tab" href="#group-image" role="tab" aria-controls="group-image" aria-selected="false">
              그룹 이미지 편집
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="category-tab" data-toggle="tab" href="#category" role="tab" aria-controls="category" aria-selected="false">
              <i class="fa fa-th" aria-hidden="true"></i>
              <% if @working_article.page.page_number == 1 %>
                <%= @working_article.page.section_name %> 카테고리 탭
              <% else %>
                <%= @working_article.page.section_name %> 카테고리 탭
              <% end %>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="article-batch-tab" data-toggle="tab" href="#article-batch" role="tab" aria-controls="article-batch" aria-selected="false">
              <% if @working_article.page.page_number == 1 %>
                <%= @working_article.page.section_name %>
              <% else %>
                <%= "#{@working_article.page.section_name}" %>면
              <% end %> 기사배정
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="preview-tab" data-toggle="tab" href="#preview" role="tab" aria-controls="preview" aria-selected="false">
              <%= @working_article.page.page_number %>면 미리보기
            </a>
          </li>
        </ul>
        <div class="tab-content" id="myTabContent">
          <!-- 기사 편집 -->
          <div class="tab-pane fade show active" id="edit" role="tabpanel" aria-labelledby="edit-tab">
            <div class="row" style="width: 100%;">
              <div class="col-md-3">
                <% @pages.each do |page| %>
                  <div class="card mb-3">
                    <div class="border text-center" style="margin: 5px;">
                      <%= raw page.to_svg_with_jpg %>
                    </div>
                  </div>
                  <p class="text-center">
                    <% if page.color_page %>
                      <%= link_to "#{page.page_number}면", page_path(page), class: "btn btn-danger btn-sm" %>
                    <% else %>
                      <%= link_to "#{page.page_number}면", page_path(page), class: "btn btn-light btn-sm border" %>
                    <% end %>
                  </p>
                <% end %>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <h5 class="card-header">
                    기사 편집
                  </h5>
                  <div class="card-body">
                    <% if @working_article.kind == '사설' || @working_article.kind == 'editorial' %>
                      <%= render 'editorial', article:@working_article, page_number:@working_article.page_number%>
                    <% elsif @working_article.kind == '기고' || @working_article.kind == 'opinion' %>
                      <%= render 'opinion', article: @working_article %>
                    <% else %>
                      <%= render 'form', article: @working_article %>
                    <% end %>
                  </div>
                </div>
              </div>
              <div class="col-md-5">
                <%= render 'show_preview', article: @working_article %>
              </div>
            </div>
          </div>
          <!-- 사진 편집 탭 -->
          <div class="tab-pane fade" id="picture" role="tabpanel" aria-labelledby="picture-tab">
            <div class="row" style="width: 100%;">
              <div class="col-md-3">
                <% @pages.each do |page| %>
                  <div class="card">
                    <div class="border text-center" style="margin: 5px;">
                      <%= raw page.to_svg_with_jpg %>
                    </div>
                    <div class="card-body text-center">
                      <% if page.color_page %>
                        <%= link_to "#{page.page_number}면", page_path(page), class: "btn btn-danger btn-sm" %>
                      <% else %>
                        <%= link_to "#{page.page_number}면", page_path(page), class: "btn btn-light btn-sm border" %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <h5 class="card-header">
                    사진 편집
                  </h5>
                  <div class="card-body">
                    <% if @working_article.kind == '기사' || @working_article.kind == '사진' || @working_article.kind == '박스기고' %>
                      <% @working_article.images.sort_by{|x| x.id}.each do |image| %>
                        <%= render 'images/form', image: image %>
                      <% end %>
                      <% if @working_article.images.length < 3 %>
                        <%= form_with( model: @working_article, :html => { :multipart => true }, :url=>{action: 'upload_images'}) do |f| %>
                          <%= f.fields_for :images, Image.new do |p| %>
                            <div class="form-group">
                              <%= f.label :storage_image, "사진 첨부"%>
                              <%= f.file_field :storage_image, class: "form-control-file" %>
                            </div>
                            <div class="form-group">
                              <%= f.button "사진 올리기", issue: @working_article.issue, class: "btn btn-primary btn-sm", data: {disable_with: "<i class='fa fa-spinner fa-spin'></i> 처리중..."} %>
                            </div>
                          <% end %>
                        <% end %>
                        <% link_to "이미지 추가", add_image_article_path(@working_article), method: :get, class: "btn btn-sm btn-danger" %>
                        <% link_to "저자 이미지 추가", add_personal_image_article_path(@working_article), method: :get, class: "btn btn-sm btn-danger" %>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </div>
              <div class="col-md-5">
                <%= render 'show_preview', article: @working_article %>
              </div>
            </div>
          </div>
          <!-- 그래픽 편집 탭-->
          <div class="tab-pane fade" id="graphic" role="tabpanel" aria-labelledby="graphic-tab">
            <div class="row" style="width: 100%;">
              <div class="col-md-3">
                <% @pages.each do |page| %>
                  <div class="card">
                    <div class="border text-center" style="margin: 5px;">
                      <%= raw page.to_svg_with_jpg %>
                    </div>
                    <div class="card-body text-center">
                      <% if page.color_page %>
                        <%= link_to "#{page.page_number}면", page_path(page), class: "btn btn-danger btn-sm" %>
                      <% else %>
                        <%= link_to "#{page.page_number}면", page_path(page), class: "btn btn-light btn-sm border" %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <h5 class="card-header">
                    그래픽 편집
                  </h5>
                  <div class="card-body">
                    <% if @working_article.kind == '기사' || @working_article.kind == '사진' || @working_article.kind == '박스기고' %>
                      <% if @reporter_graphics.length > 0 %>
                        <%= render 'reporter_graphic', reporter_graphics: @reporter_graphics %>
                      <% end %>
                      <% @working_article.graphics.each do |graphic| %>
                        <%= render 'graphics/form', graphic: graphic %>
                      <% end %>
                      <% if  @working_article.graphics.length <= 2 %>
                        <%= form_with( model: @working_article, :html => { :multipart => true }, :url=>{action: 'upload_graphics'}) do |f| %>
                          <%= f.fields_for :images, Image.new do |p| %>
                            <div class="form-group">
                              <label class="btn btn-warning btn-sm">그래픽 파일선택<%= p.file_field :image, style: "display: none;", multiple: true, name: "images[image][]" %></label>
                              <input type="text" placeholder="선택한 파일 없음" class="form-control width2 btn-sm" readonly="readonly">
                            </div>
                          <% end %>
                          <div class="actions">
                            <%= f.button "그래픽 올리기", issue: @working_article.issue, class: "btn btn-primary btn-sm", data: {disable_with: "<i class='fa fa-spinner fa-spin'></i> 처리중..."} %>
                          </div>
                        <% end %>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </div>
              <div class="col-md-5">
                <%= render 'show_preview', article: @working_article %>
              </div>
            </div>
          </div>
          <!-- 그룹 이미지 탭 -->
          <div class="tab-pane fade" id="group-image" role="tabpanel" aria-labelledby="group-image-tab">
            <div class="row" style="width: 100%;">
              <div class="col-md-4">
                <h3 class="text-center">그룹 이미지 생성</h3>
                <%= form_for @group_image do |f| %>
                  <div class="form-group">
                    <%= f.label :title, "제목:" %>
                    <%= f.text_field :title, class: "form-control", placeholder: "제목을 입력해주세요." %>
                  </div>
                  <div class="form-group">
                    <%= f.label :caption, "캡션:" %>
                    <%= f.text_field :caption, class: "form-control", placeholder: "업로드 사진에 대해 설명을 입력해주세요." %>
                  </div>
                  <div class="form-group">
                    <%= f.label :source, "출처:" %>
                    <%= f.text_field :source, class: "form-control", placeholder: "출처를 입력해주세요." %>
                  </div>
                  <div class="form-group">
                    <%= f.label :direction, "주축설정:"%>
                    <%= f.radio_button :direction, "row"  %>
                    <%= f.label :direction, "가로", value: "가로" %>
                    <%= f.radio_button :direction, "column"  %>
                    <%= f.label :direction, "세로", value: "세로" %>
                  </div>
                  <div class="form-group text-center border pt-3 pb-3">
                    <%= f.label :position, "위치설정:"%>
                    <div class="form-check" id="group_image_position" style="font-size: 13px;">
                      <%= f.radio_button :position, 10, title: "제목위", disabled: "disabled" %>
                      <%= f.radio_button :position, 0, title: "제목위" %>
                      <%= f.radio_button :position, 10, title: "제목위", disabled: "disabled" %><br />
                      <%= f.radio_button :position, 1, title: "좌상단" %>
                      <%= f.radio_button :position, 2, title: "중상단" %>
                      <%= f.radio_button :position, 3, title: "우상단" %><br>
                      <%= f.radio_button :position, 4, title: "좌" %>
                      <%= f.radio_button :position, 5, title: "중앙" %>
                      <%= f.radio_button :position, 6, title: "우" %><br>
                      <%= f.radio_button :position, 7, title: "좌하단"%>
                      <%= f.radio_button :position, 8, title: "중하단" %>
                      <%= f.radio_button :position, 9, title: "우하단" %><br>
                    </div>
                  </div>
                  <div class="form-group">
                    <%= f.hidden_field :working_article_id, value: @working_article.id %>
                  </div>
                  <div class="form-group mt-3">
                    <%= f.submit "등록", redirect_to: @working_article.id, class: "btn btn-primary btn-lg btn-block" %>
                  </div>
                <% end %>
              </div>
              <div class="col-md-8">
                <h3 class="text-center">그룹이미지 목록</h3>
                <p class="text-center"><small>그룹이미지 제목을 클릭하시면 됩니다!</small></p>
                <table class="table table-bordered">
                  <thead class="thead-dark">
                    <tr>
                      <th>제목</th>
                      <th>설명</th>
                      <th>출처</th>
                      <th>주축방향</th>
                      <th>위치</th>
                      <th>액션</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @group_images.each do |group| %>
                      <% if group.working_article_id == @working_article.id %>
                        <tr>
                          <td class="align-middle"><%= link_to group.title, group %></td>
                          <td class="align-middle"><%= group.caption %></td>
                          <td class="align-middle"><%= group.source %></td>
                          <td class="align-middle"><%= group.direction %></td>
                          <td class="align-middle"><%= group.position %></td>
                          <td>
                            <%= link_to "편집", edit_group_image_path(group), class: "btn btn-info" %>
                            <%= link_to '삭제', group_image_path(group), method: :delete, class: "btn btn-danger" %>
                          </td>
                        </tr>
                      <% end %>
                    <% end %>
                  </tbody>
                </table>
                <hr>
                <h3 class="text-center">미리보기</h3>
              </div>
            </div>
          </div>
          <!-- 카테고리 탭 -->
          <div class="tab-pane fade" id="category" role="tabpanel" aria-labelledby="category-tab">
            <div class="row">
              <% @pages.each do |page| %>
                <div class="col-md-3">
                  <div class="card">
                    <div class="border text-center" style="margin: 5px;">
                      <%= raw page.to_svg_with_jpg %>
                    </div>
                    <div class="card-body text-center">
                      <% if page.color_page %>
                        <%= link_to "#{page.page_number}면", page_path(page), class: "btn btn-danger btn-sm" %>
                      <% else %>
                        <%= link_to "#{page.page_number}면", page_path(page), class: "btn btn-light btn-sm border" %>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
              <div class="col-md-9"></div>
            </div>
          </div>
          <!-- 해당 페이지 기사 배정 -->
          <div class="tab-pane fade" id="article-batch" role="tabpanel" aria-labelledby="article-batch-tab">
            <div class="row">
              <div class="col-md-3">
                <% @pages.each do |page| %>
                  <div class="card">
                    <div class="border text-center" style="margin: 5px;">
                      <%= raw page.to_svg_with_jpg %>
                    </div>
                    <div class="card-body text-center">
                      <% if page.color_page %>
                        <%= link_to "#{page.page_number}면", page_path(page), class: "btn btn-danger btn-sm" %>
                      <% else %>
                        <%= link_to "#{page.page_number}면", page_path(page), class: "btn btn-light btn-sm border" %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
              <div class="col-md-9">
                <% @pages.each do |page| %>
                  <h4 class="display-4 text-center" style="font-size: 35px;">
                    <%= "#{page.section_name} #{page.page_number}페이지 기사 목록" %>
                  </h4>
                  <table class="table table-bordered">
                    <thead>
                      <tr class="text-center">
                        <th scope="col">배치 번호</th>
                        <th scope="col">저자</th>
                        <th scope="col">제목</th>
                        <th scope="col">예상 글자 수</th>
                        <th scope="col">기사 배정</th>
                        <th scope="col">기사 편집</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% page.working_articles.sort_by{|a| a.order}.each do |working_article| %>
                        <% if working_article.story %>
                          <tr class="bg-info">
                          <% else %>
                            <tr>
                            <% end %>
                            <td><%= working_article.order %></td>
                            <td><%= working_article.reporter %></td>
                            <td><%= working_article.title %></td>
                            <td><%= working_article.approximate_char_count %></td>
                            <td class="text-center">
                              <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                  배정 번호
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                  <% working_article.page.position_list.each do |list| %>
                                    <%= link_to list, list, class: "dropdown-item" %>
                                  <% end %>
                                  <%#= f.select (working_article.page.position_list) %>
                                </div>
                              </div>
                            </td>
                            <td class="text-center"><%= link_to '편집',working_article_path(working_article), method: :get, class: "btn btn-info btn-sm" %></td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  <% end %>
                </div>
              </div>
            </div>
            <!-- 기사 미리보기 -->
            <div class="tab-pane fade" id="preview" role="tabpanel" aria-labelledby="preview-tab">
              <div class="row d-flex justify-content-center">
                <div class="col-md-7">
                  <div class="card">
                    <div class="text-center border">
                      <%= raw @working_article.page.to_svg_with_jpg %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <nav class="navbar navbar-light bg-light fixed-bottom">
        <div class="btn-group" role="group" aria-label="기능">
          <%= link_to "교정 전송", send_proof_reading_pdf_page_path(@working_article.page), method: :get, data: { confirm: '정말 보내시겠습니까?'}, class: "btn btn-secondary btn-sm" %>
          <%= link_to "인쇄 전송", send_pdf_to_printer_page_path(@working_article.page), method: :get, data: { confirm: '정말 보내시겠습니까?'}, class: "btn btn-secondary btn-sm" %>
          <%= link_to "페이지 PDF", download_pdf_page_path(@working_article.page), method: :get, class: "btn btn-secondary btn-sm" %>
          <%= link_to "기사 PDF", download_pdf_working_article_path(@working_article), method: :get, class: "btn btn-secondary btn-sm" %>
        </div>
      </nav>
    </div>
  </div>
</div>
